name: CI
on: [push]
jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm run coverage
  jose:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Private Key
        id: generate_private_key
        uses: ./
        with:
          transmute: |
            jose keygen --alg ES256 --verbose --output ./private.sig.jwk.json
      - name: Attempt to Log Private Key
        run: echo "${{ steps.generate_private_key.outputs.json }}"
      - name: Public Key
        id: extract_public_key
        uses: ./
        with:
          transmute: |
            jose keypub ./private.sig.jwk.json --output ./public.sig.jwk.json
      - name: Log Public Key
        run: cat ./public.sig.jwk.json
      - name: Sign Message
        id: sign_message
        uses: ./
        with:
          transmute: |
            jose sign ./tests/fixtures/private.sig.jwk.json ./tests/fixtures/message.json --detached --compact --output ./tests/fixtures/message.signature.detached.compact.jws
      - name: Attempt to Log Signature
        run: echo "${{ steps.sign_message.outputs.jws }}"
      - name: Verify Message
        id: verify_message
        uses: ./
        with:
          transmute: |
            jose verify ./tests/fixtures/public.sig.jwk.json ./tests/fixtures/message.signature.detached.compact.jws ./tests/fixtures/message.json --detached --compact
      - name: Log Message Verification
        run: echo "${{ steps.verify_message.outputs.json }}"
      - name: Encrypt Message
        id: encrypt_message
        uses: ./
        with:
          transmute: |
            jose encrypt ./tests/fixtures/public.enc.jwk.json ./tests/fixtures/message.json --enc A128GCM --compact --output ./tests/fixtures/message.ciphertext.compact.jwe
      - name: Attempt to Log Ciphertext
        run: echo "${{ steps.encrypt_message.outputs.jwe }}"
      - name: Decrypt Message
        id: decrypt_message
        uses: ./
        with:
          transmute: |
            jose decrypt ./tests/fixtures/private.enc.jwk.json ./tests/fixtures/message.ciphertext.compact.jwe --compact
      - name: Log Message Decryption
        run: echo "${{ steps.decrypt_message.outputs.json }}"
